<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{base::layout(~{::section})}">
<head>
    <meta charset="UTF-8">
    <title>Loan Payment</title>
</head>
<body>
    <section class="container mt-5">
        <div class="card" style="max-width: 600px; margin: 0 auto;">
            <div class="card-header text-center">
                <h1 class="h2">Loan Payment</h1>
            </div>
            <div class="card-body">
                <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
                <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

                <div th:if="${#lists.isEmpty(loans)}">
                    <div class="alert alert-info">
                        <h5>No Approved Loans</h5>
                        <p>You don't have any approved loans to make payments for.</p>
                    </div>
                </div>

                <div th:if="${!#lists.isEmpty(loans)}">
                    <form th:action="@{/loan-payment}" method="post">
                        <div class="mb-3">
                            <label for="loanId" class="form-label">Select Loan</label>
                            <select id="loanId" name="loanId" class="form-select" required onchange="updateLoanDetails()">
                                <option value="" disabled selected>Select a loan</option>
                                <option th:each="loan : ${loans}"
                                        th:value="${loan.id}"
                                        th:text="|Loan ID: ${loan.id} - Amount: ₹${#numbers.formatDecimal(loan.amount, 1, 2)} - Remaining: ₹${#numbers.formatDecimal(loan.remainingBalance, 1, 2)}|"
                                        th:data-remaining="${loan.remainingBalance}"></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="accountId" class="form-label">Payment Account</label>
                            <select id="accountId" name="accountId" class="form-select" required>
                                <option value="" disabled selected>Select payment account</option>
                                <option th:each="account : ${accounts}"
                                        th:value="${account.id}"
                                        th:text="|${account.accountNumber} - Balance: ₹${#numbers.formatDecimal(account.balance, 1, 2)}|"></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="amount" class="form-label">Payment Amount (₹)</label>
                            <input type="number" id="amount" name="amount" class="form-control" required min="1" step="0.01">
                            <div class="form-text" id="remainingText"></div>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">Make Payment</button>
                            <a href="/user/dashboard" class="btn btn-warning ms-2">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <script>
        function updateLoanDetails() {
            const select = document.getElementById('loanId');
            const selectedOption = select.options[select.selectedIndex];
            const remaining = selectedOption.getAttribute('data-remaining');
            const remainingText = document.getElementById('remainingText');
            if (remaining) {
                remainingText.textContent = 'Remaining balance: ₹' + parseFloat(remaining).toFixed(2);
            } else {
                remainingText.textContent = '';
            }
        }
    </script>
</body>
</html>